<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîç AMORPH System Full Check</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #0f0f23;
      color: #e0e0e0;
      padding: 2rem;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #667eea;
      margin-bottom: 1rem;
      font-size: 2rem;
    }
    h2 {
      color: #f093fb;
      margin: 2rem 0 1rem;
      font-size: 1.5rem;
      border-bottom: 2px solid #667eea;
      padding-bottom: 0.5rem;
    }
    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      margin-left: 1rem;
    }
    .status.success { background: #10b981; color: white; }
    .status.error { background: #ef4444; color: white; }
    .status.warning { background: #f59e0b; color: white; }
    .status.info { background: #3b82f6; color: white; }
    
    .test-section {
      background: #1a1a2e;
      border: 1px solid #2a2a3e;
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .test-item {
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: #16162a;
      border-left: 3px solid #667eea;
      border-radius: 0.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .test-item.pass { border-left-color: #10b981; }
    .test-item.fail { border-left-color: #ef4444; }
    .test-item.pending { border-left-color: #f59e0b; }
    
    pre {
      background: #0a0a15;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      font-size: 0.875rem;
      border: 1px solid #2a2a3e;
      margin: 0.5rem 0;
    }
    code {
      color: #a5d6ff;
      font-family: 'Cascadia Code', 'Fira Code', monospace;
    }
    .icon {
      font-size: 1.25rem;
      margin-right: 0.5rem;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    .metric {
      background: #16162a;
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
    }
    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      margin: 0.5rem 0;
    }
    .metric-label {
      font-size: 0.875rem;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .log-entry {
      padding: 0.5rem;
      margin: 0.25rem 0;
      border-radius: 0.25rem;
      font-family: monospace;
      font-size: 0.875rem;
    }
    .log-entry.info { background: #1e3a5f; color: #60a5fa; }
    .log-entry.success { background: #1e4d3a; color: #34d399; }
    .log-entry.error { background: #4d1e1e; color: #f87171; }
    .log-entry.warn { background: #4d3d1e; color: #fbbf24; }
    
    #console-output {
      max-height: 400px;
      overflow-y: auto;
      background: #0a0a15;
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #2a2a3e;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç AMORPH System Full Check</h1>
    
    <div class="test-section">
      <h2>üéÆ Control Panel</h2>
      <button onclick="runFullCheck()">üîÑ Run Full System Check</button>
      <button onclick="checkRedis()">üì° Check Redis Connection</button>
      <button onclick="testRedisStreams()">üåä Test Redis Streams</button>
      <button onclick="checkObservers()">üëÅÔ∏è Check Stream Observers</button>
      <button onclick="checkReactors()">‚ö° Check Reactors</button>
      <button onclick="checkMorphs()">üß¨ Check Morphs</button>
      <button onclick="inspectSystem()">üîç Inspect System</button>
      <button onclick="clearConsole()">üóëÔ∏è Clear Console</button>
    </div>

    <div class="test-section">
      <h2>üìä System Metrics</h2>
      <div class="grid" id="metrics"></div>
    </div>

    <div class="test-section">
      <h2>‚úÖ System Tests</h2>
      <div id="test-results"></div>
    </div>

    <div class="test-section">
      <h2>üí¨ Console Output</h2>
      <div id="console-output"></div>
    </div>
  </div>

  <script type="module">
    let amorph = null;
    const testResults = [];
    
    // Intercept console
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    function addToConsole(type, ...args) {
      const output = document.getElementById('console-output');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${args.map(a => 
        typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)
      ).join(' ')}`;
      output.appendChild(entry);
      output.scrollTop = output.scrollHeight;
    }
    
    console.log = (...args) => {
      originalLog(...args);
      addToConsole('info', ...args);
    };
    
    console.error = (...args) => {
      originalError(...args);
      addToConsole('error', ...args);
    };
    
    console.warn = (...args) => {
      originalWarn(...args);
      addToConsole('warn', ...args);
    };
    
    window.clearConsole = () => {
      document.getElementById('console-output').innerHTML = '';
    };
    
    // Load AMORPH
    async function loadAmorph() {
      try {
        console.log('üîÆ Loading AMORPH System...');
        const module = await import('/src/amorph/init.js');
        amorph = module.amorph || window.amorph;
        
        if (!amorph) {
          throw new Error('AMORPH not found in module or window');
        }
        
        console.log('‚úÖ AMORPH loaded successfully');
        return true;
      } catch (err) {
        console.error('‚ùå Failed to load AMORPH:', err);
        return false;
      }
    }
    
    function addTest(name, status, details = '') {
      const container = document.getElementById('test-results');
      const item = document.createElement('div');
      item.className = `test-item ${status}`;
      
      const icon = status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥';
      
      item.innerHTML = `
        <div>
          <span class="icon">${icon}</span>
          <strong>${name}</strong>
          ${details ? `<div style="margin-left: 2rem; color: #9ca3af; font-size: 0.875rem;">${details}</div>` : ''}
        </div>
        <span class="status ${status === 'pass' ? 'success' : status === 'fail' ? 'error' : 'warning'}">
          ${status.toUpperCase()}
        </span>
      `;
      
      container.appendChild(item);
      testResults.push({ name, status, details });
    }
    
    function updateMetrics(metrics) {
      const container = document.getElementById('metrics');
      container.innerHTML = Object.entries(metrics).map(([key, value]) => `
        <div class="metric">
          <div class="metric-label">${key}</div>
          <div class="metric-value">${value}</div>
        </div>
      `).join('');
    }
    
    // System Tests
    window.runFullCheck = async () => {
      document.getElementById('test-results').innerHTML = '';
      console.log('üöÄ Starting full system check...');
      
      // Test 1: AMORPH Loading
      if (!amorph) {
        const loaded = await loadAmorph();
        addTest('AMORPH System Load', loaded ? 'pass' : 'fail');
        if (!loaded) return;
      } else {
        addTest('AMORPH System Load', 'pass', 'Already loaded');
      }
      
      // Test 2: System Info
      try {
        const info = amorph.getSystemInfo();
        console.log('üìä System Info:', info);
        addTest('System Info', 'pass', `Uptime: ${Math.floor((Date.now() - info.initTime) / 1000)}s`);
        
        updateMetrics({
          'Registered Morphs': info.morphs,
          'Registered Reactors': info.reactors,
          'Enabled Reactors': info.enabledReactors,
          'Active Perspectives': info.perspectives,
          'Observers Running': info.observersRunning ? 'Yes' : 'No'
        });
      } catch (err) {
        addTest('System Info', 'fail', err.message);
      }
      
      // Test 3: Redis Connection
      await checkRedis();
      
      // Test 4: Observers
      await checkObservers();
      
      // Test 5: Reactors
      await checkReactors();
      
      // Test 6: Morphs
      await checkMorphs();
      
      console.log('‚úÖ Full system check completed');
    };
    
    window.checkRedis = async () => {
      console.log('üì° Checking Redis connection...');
      
      try {
        if (!amorph.eventBridge) {
          addTest('Redis Event Bridge', 'fail', 'Event bridge not initialized');
          return;
        }
        
        const isConnected = amorph.eventBridge.isConnected;
        console.log('Redis connected:', isConnected);
        
        addTest('Redis Connection', isConnected ? 'pass' : 'fail', 
          isConnected ? 'Connected' : 'Not connected (expected in browser)');
        
        // Test publish
        try {
          await amorph.streamPublish('test:check', { timestamp: Date.now() });
          addTest('Redis Stream Publish', 'pass', 'Test event published');
        } catch (err) {
          addTest('Redis Stream Publish', 'pending', 'Expected to fail in browser: ' + err.message);
        }
      } catch (err) {
        console.error('Redis check error:', err);
        addTest('Redis Connection', 'fail', err.message);
      }
    };
    
    window.checkObservers = async () => {
      console.log('üëÅÔ∏è Checking stream observers...');
      
      try {
        const observers = amorph.observers;
        console.log('Observers:', observers);
        
        const observerNames = Object.keys(observers);
        const activeObservers = observerNames.filter(name => observers[name] !== null);
        
        addTest('Stream Observers', 'pass', 
          `${activeObservers.length}/${observerNames.length} initialized`);
        
        observerNames.forEach(name => {
          const observer = observers[name];
          addTest(`Observer: ${name}`, observer ? 'pass' : 'pending', 
            observer ? 'Initialized' : 'Not initialized (backend only)');
        });
      } catch (err) {
        console.error('Observer check error:', err);
        addTest('Stream Observers', 'fail', err.message);
      }
    };
    
    window.checkReactors = async () => {
      console.log('‚ö° Checking reactors...');
      
      try {
        const reactors = Array.from(amorph.reactors.keys());
        console.log('Registered reactors:', reactors);
        
        addTest('Reactor Registry', 'pass', `${reactors.length} reactors registered`);
        
        reactors.forEach(name => {
          addTest(`Reactor: ${name}`, 'pass', 'Registered');
        });
        
        const enabledReactors = Array.from(amorph.state.enabledReactors.keys());
        console.log('Enabled reactors:', enabledReactors);
        
        if (enabledReactors.length > 0) {
          addTest('Enabled Reactors', 'pass', `${enabledReactors.length} active`);
        } else {
          addTest('Enabled Reactors', 'pending', 'None enabled yet');
        }
      } catch (err) {
        console.error('Reactor check error:', err);
        addTest('Reactors', 'fail', err.message);
      }
    };
    
    window.checkMorphs = async () => {
      console.log('üß¨ Checking morphs...');
      
      try {
        const morphs = Array.from(amorph.morphs);
        console.log('Registered morphs:', morphs.length);
        
        addTest('Morph Registry', morphs.length > 0 ? 'pass' : 'pending', 
          `${morphs.length} morphs registered`);
        
        if (morphs.length > 0) {
          const morphTypes = {};
          morphs.forEach(morph => {
            const type = morph.dataset?.morphType || 'unknown';
            morphTypes[type] = (morphTypes[type] || 0) + 1;
          });
          
          console.log('Morph types:', morphTypes);
          Object.entries(morphTypes).forEach(([type, count]) => {
            addTest(`Morph Type: ${type}`, 'pass', `${count} instances`);
          });
        }
      } catch (err) {
        console.error('Morph check error:', err);
        addTest('Morphs', 'fail', err.message);
      }
    };
    
    // Additional Redis Stream checks
    window.testRedisStreams = async () => {
      console.log('üì° Testing Redis Streams functionality...');
      
      try {
        // Test 1: Check Event Bridge config
        const bridgeConfig = amorph.eventBridge?.config;
        console.log('Event Bridge Config:', bridgeConfig);
        addTest('Event Bridge Config', bridgeConfig ? 'pass' : 'fail', 
          bridgeConfig ? JSON.stringify(bridgeConfig, null, 2) : 'Not found');
        
        // Test 2: Check if in browser
        const isBrowser = typeof window !== 'undefined';
        console.log('Running in Browser:', isBrowser);
        addTest('Runtime Environment', 'info', isBrowser ? 'Browser (Redis disabled)' : 'Node.js (Redis enabled)');
        
        // Test 3: Try to publish test event
        try {
          const result = await amorph.streamPublish('test:diagnostic', {
            timestamp: Date.now(),
            message: 'System diagnostic check'
          });
          console.log('Stream publish result:', result);
          addTest('Stream Publish Test', 'pass', 'Event published (or queued)');
        } catch (err) {
          console.warn('Stream publish failed (expected in browser):', err.message);
          addTest('Stream Publish Test', 'pending', 'Expected to fail in browser: ' + err.message);
        }
        
        // Test 4: Check local event system
        let eventReceived = false;
        amorph.on('test:local', (data) => {
          eventReceived = true;
          console.log('‚úÖ Local event received:', data);
        });
        
        amorph.emit('test:local', { test: 'data' });
        
        await new Promise(resolve => setTimeout(resolve, 100));
        addTest('Local Event System', eventReceived ? 'pass' : 'fail', 
          eventReceived ? 'Events working' : 'Events not received');
        
        // Test 5: Check observer states
        if (amorph.observers) {
          const observerStates = Object.entries(amorph.observers).map(([name, obs]) => {
            return {
              name,
              exists: obs !== null,
              running: obs?.running || false
            };
          });
          console.log('Observer States:', observerStates);
          
          observerStates.forEach(state => {
            addTest(`Observer ${state.name}`, 
              state.exists ? (state.running ? 'pass' : 'pending') : 'fail',
              state.exists ? (state.running ? 'Running' : 'Not started (backend only)') : 'Not initialized');
          });
        }
        
        console.log('‚úÖ Redis Stream tests completed');
      } catch (err) {
        console.error('‚ùå Redis Stream test error:', err);
        addTest('Redis Streams', 'fail', err.message);
      }
    };
    
    // Console inspection helper
    window.inspectSystem = () => {
      console.log('=== AMORPH SYSTEM INSPECTION ===');
      console.log('1. System Info:', amorph.getSystemInfo());
      console.log('2. Event Bridge:', amorph.eventBridge);
      console.log('3. Observers:', amorph.observers);
      console.log('4. Reactors:', Array.from(amorph.reactors.keys()));
      console.log('5. Enabled Reactors:', Array.from(amorph.state.enabledReactors.keys()));
      console.log('6. Registered Morphs:', amorph.morphs.size);
      console.log('7. Config:', amorph.config);
      console.log('================================');
    };
    
    // Auto-run on load
    window.addEventListener('load', async () => {
      await new Promise(resolve => setTimeout(resolve, 1000));
      await runFullCheck();
      await new Promise(resolve => setTimeout(resolve, 500));
      await testRedisStreams();
      
      console.log('\nüí° Available commands:');
      console.log('  - runFullCheck() - Run all system tests');
      console.log('  - testRedisStreams() - Test Redis Stream functionality');
      console.log('  - inspectSystem() - Full system inspection');
      console.log('  - checkRedis() - Check Redis connection');
      console.log('  - checkObservers() - Check all observers');
      console.log('  - checkReactors() - Check reactor registry');
      console.log('  - checkMorphs() - Check morph registry');
    });
  </script>
</body>
</html>
