---
import BaseLayout from '@/amorph/core/layouts/BaseLayout.astro';
import { fetchEntity } from '@/amorph/core/convex';

const { slug } = Astro.params;
const entity = await fetchEntity(slug!);
if (!entity) return Astro.redirect('/fungi');

function renderValue(value: any, key: string) {
  if (value === null || value === undefined) return null;
  const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
  if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'string') return { type: 'tags', label, values: value };
  if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object') return { type: 'nested-array', label, values: value };
  if (typeof value === 'object' && value.min !== undefined && value.max !== undefined) return { type: 'range', label, value: `${value.min}-${value.max} ${value.unit || ''}`.trim() };
  if (typeof value === 'object' && !Array.isArray(value)) return { type: 'nested', label, value };
  if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') return { type: 'text', label, value: String(value) };
  return null;
}

function renderAllFields(obj: any, maxDepth = 3, currentDepth = 0): any[] {
  if (!obj || currentDepth >= maxDepth) return [];
  const results: any[] = [];
  for (const [key, value] of Object.entries(obj)) {
    const rendered = renderValue(value, key);
    if (rendered) results.push(rendered);
  }
  return results;
}

const perspectives = [
  { id: 'taxonomy', title: 'Taxonomy', icon: 'ğŸ§¬', color: '#ef4444', data: entity.taxonomy },
  { id: 'morphology', title: 'Physical', icon: 'ğŸ‘ï¸', color: '#f97316', data: entity.morphology },
  { id: 'ecologicalNetwork', title: 'Ecology', icon: 'ğŸŒ', color: '#eab308', data: entity.ecologicalNetwork },
  { id: 'culinaryDimensions', title: 'Culinary', icon: 'ğŸ³', color: '#22c55e', data: entity.culinaryDimensions },
  { id: 'medicinalIntelligence', title: 'Medicinal', icon: 'âš•ï¸', color: '#06b6d4', data: entity.medicinalIntelligence },
  { id: 'cultivationIntelligence', title: 'Cultivation', icon: 'ğŸŒ±', color: '#3b82f6', data: entity.cultivationIntelligence },
  { id: 'sensoryProfile', title: 'Sensory', icon: 'âš ï¸', color: '#8b5cf6', data: entity.sensoryProfile },
  { id: 'chemicalUniverse', title: 'Chemical', icon: 'ğŸ§ª', color: '#ec4899', data: entity.chemicalUniverse },
  { id: 'culturalDimensions', title: 'Cultural', icon: 'ğŸ“œ', color: '#d946ef', data: entity.culturalDimensions },
  { id: 'economicDimensions', title: 'Economic', icon: 'ğŸ’°', color: '#14b8a6', data: entity.economicDimensions },
  { id: 'environmentalAndConservation', title: 'Environment', icon: 'ğŸŒ¿', color: '#10b981', data: entity.environmentalAndConservation },
  { id: 'researchAndInnovation', title: 'Innovation', icon: 'ğŸ”¬', color: '#0ea5e9', data: entity.researchAndInnovation }
];
---
<BaseLayout title={`${entity.commonName} - Funginomi`} description={entity.description} enableGlow={true} enableSearch={false} enableAnimation={true} showPerspectives={true}>
<div class="entity-detail">
<section class="hero">
<div class="hero-image">{entity.imageUrl && (<image-morph src={entity.imageUrl} alt={entity.commonName} width="100%" height="400px" style="border-radius: 16px;"></image-morph>)}</div>
<div class="hero-content"><name-morph value={entity.commonName} subtitle={entity.latinName} size="large"></name-morph>{entity.description && (<text-morph value={entity.description} label="Description"></text-morph>)}</div>
</section>
{perspectives.map(p => { if (!p.data) return null; const fields = renderAllFields(p.data); if (fields.length === 0) return null; return (<perspective-host perspective={p.id} title={p.title} icon={p.icon} color={p.color}>{fields.map(f => { if (f.type === 'tags') return (<div class="morph-wrapper"><label class="morph-label">{f.label}</label><div class="tags-container">{f.values.map((t: string) => (<tag-morph tag={t}></tag-morph>))}</div></div>); if (f.type === 'range' || f.type === 'text') return <text-morph value={f.value} label={f.label}></text-morph>; if (f.type === 'nested') { const sub = renderAllFields(f.value, 2, 1); return (<div class="nested-section"><h4 class="nested-title">{f.label}</h4>{sub.map(s => { if (s.type === 'tags') return (<div class="morph-wrapper"><label class="morph-label">{s.label}</label><div class="tags-container">{s.values.map((t: string) => (<tag-morph tag={t}></tag-morph>))}</div></div>); if (s.type === 'range' || s.type === 'text') return <text-morph value={s.value} label={s.label}></text-morph>; return null; })}</div>); } return null; })}</perspective-host>); })}
</div>
</BaseLayout>
<style>.entity-detail{max-width:1400px;margin:0 auto;padding:2rem}.hero{margin-bottom:3rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem}.hero-image{border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.2)}.hero-content{display:flex;flex-direction:column;gap:1.5rem}.morph-wrapper{background:rgba(255,255,255,.03);padding:1.5rem;border-radius:8px;border:1px solid rgba(255,255,255,.1);margin-bottom:1rem}.morph-label{display:block;font-size:.875rem;font-weight:600;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.75rem}.tags-container{display:flex;flex-wrap:wrap;gap:.5rem}.nested-section{margin-bottom:1.5rem;padding-left:1rem;border-left:3px solid rgba(255,255,255,.2)}.nested-title{font-size:1.125rem;font-weight:600;color:rgba(255,255,255,.9);margin-bottom:1rem;text-transform:capitalize}@media (max-width:768px){.entity-detail{padding:1rem}.hero{grid-template-columns:1fr}}</style>
<script>import '@/amorph/features/perspective-system/PerspectiveHost.js';const d=['taxonomy','ecologyAndHabitat','culinaryAndNutritional','safetyAndIdentification'];window.addEventListener('DOMContentLoaded',()=>{window.dispatchEvent(new CustomEvent('perspective-changed',{detail:{perspectives:d}}));console.log('[Detail] Init:',d);});</script>