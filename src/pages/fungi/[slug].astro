---
import BaseLayout from '@/amorph/core/layouts/BaseLayout.astro';
import { fetchEntity } from '@/amorph/core/convex';

const { slug } = Astro.params;
const entity = await fetchEntity(slug!);
if (!entity) return Astro.redirect('/fungi');

// Deep recursive renderer - renders ALL nested data
function flattenObject(obj: any, prefix = '', maxDepth = 5, currentDepth = 0): any[] {
  if (!obj || currentDepth >= maxDepth) return [];
  const results: any[] = [];
  
  for (const [key, value] of Object.entries(obj)) {
    if (value === null || value === undefined) continue;
    
    const fullKey = prefix ? `${prefix}.${key}` : key;
    const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
    
    // Array of strings ‚Üí tags (filter empty strings!)
    if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'string') {
      const validStrings = value.filter((s: string) => s && s.trim().length > 0);
      if (validStrings.length > 0) {
        results.push({ type: 'tags', label, key: fullKey, values: validStrings });
      }
      continue;
    }
    
    // Array of objects ‚Üí render each object
    if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object') {
      value.forEach((item, idx) => {
        const subItems = flattenObject(item, `${fullKey}[${idx}]`, maxDepth, currentDepth + 1);
        results.push(...subItems);
      });
      continue;
    }
    
    // Empty array ‚Üí skip
    if (Array.isArray(value) && value.length === 0) continue;
    
    // Object with min/max/unit ‚Üí range
    if (typeof value === 'object' && value.min !== undefined && value.max !== undefined) {
      results.push({ 
        type: 'text', 
        label, 
        key: fullKey, 
        value: `${value.min}-${value.max} ${value.unit || ''}`.trim() 
      });
      continue;
    }
    
    // Plain object ‚Üí recurse into it
    if (typeof value === 'object' && !Array.isArray(value)) {
      const nested = flattenObject(value, fullKey, maxDepth, currentDepth + 1);
      if (nested.length > 0) {
        results.push({ type: 'section', label, key: fullKey, children: nested });
      }
      continue;
    }
    
    // Primitive values (skip empty strings!)
    if (typeof value === 'string') {
      if (value.trim().length > 0) {
        results.push({ type: 'text', label, key: fullKey, value: value.trim() });
      }
    } else if (typeof value === 'number' || typeof value === 'boolean') {
      results.push({ type: 'text', label, key: fullKey, value: String(value) });
    }
  }
  
  return results;
}

const perspectives = [
  { id: 'taxonomy', title: 'Taxonomy', icon: 'üß¨', color: '#ef4444', data: entity.taxonomy },
  { id: 'physicalCharacteristics', title: 'Physical', icon: 'üëÅÔ∏è', color: '#f97316', data: entity.physicalCharacteristics },
  { id: 'ecologyAndHabitat', title: 'Ecology', icon: 'üåç', color: '#eab308', data: entity.ecologyAndHabitat },
  { id: 'culinaryAndNutritional', title: 'Culinary', icon: 'üç≥', color: '#22c55e', data: entity.culinaryAndNutritional },
  { id: 'medicinalAndHealth', title: 'Medicinal', icon: '‚öïÔ∏è', color: '#06b6d4', data: entity.medicinalAndHealth },
  { id: 'cultivationAndProcessing', title: 'Cultivation', icon: 'üå±', color: '#3b82f6', data: entity.cultivationAndProcessing },
  { id: 'safetyAndIdentification', title: 'Safety', icon: '‚ö†Ô∏è', color: '#8b5cf6', data: entity.safetyAndIdentification },
  { id: 'chemicalAndProperties', title: 'Chemical', icon: 'üß™', color: '#ec4899', data: entity.chemicalAndProperties },
  { id: 'culturalAndHistorical', title: 'Cultural', icon: 'üìú', color: '#d946ef', data: entity.culturalAndHistorical },
  { id: 'commercialAndMarket', title: 'Commercial', icon: 'üí∞', color: '#14b8a6', data: entity.commercialAndMarket },
  { id: 'environmentalAndConservation', title: 'Environment', icon: 'üåø', color: '#10b981', data: entity.environmentalAndConservation },
  { id: 'researchAndInnovation', title: 'Innovation', icon: 'üî¨', color: '#0ea5e9', data: entity.researchAndInnovation }
];
---

<BaseLayout 
  title={`${entity.commonName} - Funginomi`} 
  description={entity.description} 
  enableGlow={true} 
  enableSearch={false} 
  enableAnimation={true} 
  showPerspectives={true}
>
  <div class="entity-detail">
    <section class="hero">
      <div class="hero-image">
        {entity.imageUrl && (
          <image-morph 
            src={entity.imageUrl} 
            alt={entity.commonName} 
            width="100%" 
            height="400px" 
            style="border-radius:16px"
          ></image-morph>
        )}
      </div>
      <div class="hero-content">
        <name-morph 
          value={entity.commonName} 
          subtitle={entity.latinName} 
          size="large"
        ></name-morph>
        {entity.description && (
          <text-morph 
            value={entity.description} 
            label="Description"
          ></text-morph>
        )}
      </div>
    </section>

    {perspectives.map(p => {
      if (!p.data) return null;
      const fields = flattenObject(p.data);
      if (fields.length === 0) return null;
      
      return (
        <perspective-host 
          perspective={p.id} 
          title={p.title} 
          icon={p.icon} 
          color={p.color}
        >
          {fields.map(field => {
            const renderField = (f: any, depth = 0) => {
              const marginStyle = `margin-left: ${depth * 1}rem`;
              
              if (f.type === 'tags') {
                return (
                  <div class="morph-wrapper" style={marginStyle}>
                    <label class="morph-label">{f.label}</label>
                    <div class="tags-container">
                      {f.values.map((tag: string) => <tag-morph value={tag}></tag-morph>)}
                    </div>
                  </div>
                );
              }
              
              if (f.type === 'text') {
                return (
                  <div class="morph-wrapper" style={marginStyle}>
                    <label class="morph-label">{f.label}</label>
                    <text-morph value={f.value}></text-morph>
                  </div>
                );
              }
              
              if (f.type === 'section') {
                return (
                  <div class="nested-section" style={marginStyle}>
                    <h4 class="nested-title">{f.label}</h4>
                    {f.children.map((child: any) => renderField(child, depth + 1))}
                  </div>
                );
              }
              
              return null;
            };
            
            return renderField(field, 0);
          })}
        </perspective-host>
      );
    })}
  </div>
</BaseLayout>

<style>
  .entity-detail {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .hero {
    margin-bottom: 3rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }

  .hero-image {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .hero-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .morph-wrapper {
    background: rgba(255, 255, 255, 0.03);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 1rem;
  }

  .morph-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
  }

  .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .nested-section {
    margin-bottom: 1.5rem;
    padding: 1rem;
    border-left: 3px solid rgba(255, 255, 255, 0.2);
    background: rgba(255, 255, 255, 0.02);
  }

  .nested-title {
    font-size: 1rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 1rem;
    text-transform: capitalize;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 0.5rem;
  }

  text-morph {
    display: block;
    margin-bottom: 0.75rem;
  }

  @media (max-width: 768px) {
    .entity-detail {
      padding: 1rem;
    }
    .hero {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  import '@/amorph/features/perspective-system/PerspectiveHost.js';

  const defaultPerspectives = ['taxonomy', 'ecologyAndHabitat', 'culinaryAndNutritional', 'safetyAndIdentification'];
  
  window.addEventListener('DOMContentLoaded', () => {
    window.dispatchEvent(new CustomEvent('perspective-changed', {
      detail: { perspectives: defaultPerspectives }
    }));
    console.log('[Detail Page] Initialized with deep recursion. Default perspectives:', defaultPerspectives);
  });
</script>
